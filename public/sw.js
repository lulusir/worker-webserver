"use strict";(()=>{var m=Object.defineProperty;var y=(i,e,t)=>e in i?m(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var f=(i,e,t)=>(y(i,typeof e!="symbol"?e+"":e,t),t);var d={Ready:"Ready",Close:"Close"};var o=class{constructor(e){this.pipe=e}getNewPid(){return this.pipe.newid}consume(e,t){this.pipe.write(e,t)}async send(e,t,s){if(s){let n={pid:e,data:t};s.postMessage(n)}}async receive(e){return this.pipe.read(e).then(t=>t.data)}};var c=class{constructor(e,t){this.pipeMessage=e;this.sw=t}async getClient(e){return await this.sw.clients.get(e)}async buildResponse(e){let t=this.pipeMessage.getNewPid(),s=await this.getClient(e.clientId);return s?this.pipeMessage.send(t,{req:this.serializeRequest(e.request)},s):console.warn("client not found",e),this.pipeMessage.receive(t).then(n=>n.status==="ok"?new Response(n.body):fetch(e.request))}serializeRequest(e){let t={url:e.url,method:e.method,headers:{},referrer:e.referrer,referrerPolicy:e.referrerPolicy,mode:e.mode,credentials:e.credentials,cache:e.cache,redirect:e.redirect,integrity:e.integrity,keepalive:e.keepalive};for(let[s,n]of e.headers.entries())t.headers[s]=n;return t}};var p=class{static single(){return p._instance}_id=1;get newid(){return this._id++}_pipe=new Map;read(e){return new Promise(t=>{this._pipe.set(e,{resolve:t})})}write(e,t){if(this._pipe.has(e)){let{resolve:s}=this._pipe.get(e);s&&s(t),this._pipe.delete(e)}}size(){return this._pipe.size}},a=p;f(a,"_instance",new p);function g(i){return/^(http|https):\/\//i.test(i)}var l=class{value="default";ready(){this.value="ready"}close(){this.value="close"}isReady(){return this.value==="ready"}};var r=self,u=new l,w=a.single(),h=new o(w),v=new c(h,r);r.addEventListener("install",function(){r.skipWaiting()});r.addEventListener("activate",function(i){i.waitUntil(r.clients.claim())});r.addEventListener("message",i=>{if(i.data===d.Ready){u.ready();return}if(i.data===d.Close){u.close();return}if(i.data?.pid){let{pid:e}=i.data;h.consume(e,i.data);return}});r.addEventListener("fetch",i=>{if(!u.isReady())return;let{request:e}=i;(e.headers.get("accept")||"").includes("text/event-stream")||e.mode!=="navigate"&&(e.cache==="only-if-cached"&&e.mode!=="same-origin"||g(e.url)&&i.respondWith(v.buildResponse(i)))});})();
